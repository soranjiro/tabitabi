# 認証システム

## 概要

たびたびアプリケーションでは、JWT（JSON Web Token）を用いた認証システムにより、旅程の編集権限を管理しています。

## 認証フロー

### 1. 閲覧モードから編集モードへの切り替え

ユーザーが「編集」ボタンをクリックすると、以下の手順で編集モードへの切り替えが試行されます：

1. **ローカルトークンの確認**
   - ブラウザのローカルストレージに保存されている編集用トークンを確認します。

2. **トークンの検証（トークンが存在する場合）**
   - APIサーバーに問い合わせてトークンの有効性を検証します。
   - 有効な場合：即座に編集モードに切り替わります。

3. **パスワード設定の確認（トークンがない、または無効な場合）**
   - 旅程にパスワードが設定されているかを確認します。
   - **パスワードなし**：空パスワードで認証APIを呼び出し、トークンを取得して編集モードに入ります。
   - **パスワードあり**：パスワード入力ダイアログを表示します。

4. **パスワード認証**
   - ユーザーがパスワードを入力して送信します。
   - 認証成功：サーバーからトークンが発行され、ブラウザに保存して編集モードに入ります。
   - 認証失敗：「パスワードが正しくありません」とアラート表示し、編集モードには入りません。

### 2. 予定の追加・編集・削除時の認証

すべての編集操作（POST, PUT, DELETE）では、以下の認証プロセスが実行されます：

1. **クライアント側（フロントエンド）**
   - APIリクエストのヘッダーに、ローカルストレージから取得したトークンを付与します。
   - 形式：`Authorization: Bearer <トークン>`

2. **サーバー側（バックエンド）**
   - `authMiddleware` がリクエストを受信します。
   - ヘッダーからトークンを抽出し、署名と有効期限を検証します。
   - 検証成功時、トークンに含まれる `shioriId`（旅程ID）をリクエストコンテキストに保存します。
   - 検証失敗時、`401 Unauthorized` エラーを返します。

3. **権限チェック**
   - 各APIエンドポイント内で、操作対象の旅程IDとトークンの `shioriId` が一致するかを確認します。
   - 不一致の場合、`403 Forbidden` エラーを返します。

## パスワードなし旅程の扱い

パスワードが設定されていない旅程については、以下の仕様です：

- **認証API (`/api/v1/auth/password`)**
  - `password` フィールドが空またはnullでもリクエストを受け付けます。
  - 旅程にパスワードが設定されていなければ、パスワードチェックをスキップして有効なトークンを発行します。

- **フロントエンド**
  - パスワードなしの旅程でも、空文字列で認証APIを呼び出してトークンを取得します。
  - これにより、その後の編集操作で認証エラーが発生しません。

## 実装ファイル

- **フロントエンド**
  - `/apps/web/src/lib/auth/index.ts` - トークン管理
  - `/apps/web/src/lib/api/auth.ts` - 認証API呼び出し
  - `/apps/web/src/lib/api/client.ts` - API通信時のトークン付与
  - `/apps/web/src/lib/themes/*/ItineraryView.svelte` - 編集モード切り替えロジック

- **バックエンド**
  - `/apps/api/src/routes/auth.ts` - 認証エンドポイント
  - `/apps/api/src/middleware/auth.ts` - 認証ミドルウェア
  - `/apps/api/src/routes/steps.ts` - 予定操作のエンドポイント（ミドルウェア適用）
  - `/apps/api/src/utils/jwt.ts` - JWT生成/検証ユーティリティ
